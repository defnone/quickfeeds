import DOMPurify from 'dompurify';

(()=>{function i(e,t){let n=document.createElement("div");n.innerHTML=DOMPurify.sanitize(`
            <div @click="open = false" x-data="{ open: false }" x-init="setTimeout(() => open = true, 100); setTimeout(() => open = false, 10100);" 
                x-show="open" 
                x-transition:enter="transition ease-out duration-300 transform"
                x-transition:enter-start="opacity-0 translate-x-full"
                x-transition:enter-end="opacity-100 translate-x-0"
                x-transition:leave="transition ease-in duration-300 transform"
                x-transition:leave-start="opacity-100 translate-x-0"
                x-transition:leave-end="opacity-0 translate-x-full"
                class="fixed inset-0 flex items-end z-50 justify-start px-4 py-6 pointer-events-none sm:p-6 sm:items-start sm:justify-end">
                
                <div :class="{'shadow-md bg-red-800 border-2 border-red-900': '${t}' == 'error', ' bg-green-800 border border-green-900': '${t}' == 'success'}"
                    class="max-w-sm w-full shadow-lg rounded-lg pointer-events-auto">
                    <div class="rounded-lg shadow-xs overflow-hidden">
                        <div class="p-4">
                            <div class="flex items-start">
                                <div class="ml-3 w-0 flex-1 pt-0.5">
                                    <p class="text-base leading-5 font-medium text-white">
                                        ${e}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `),document.body.appendChild(n)}function g(){fetch("/api/unread-count").then(e=>e.json()).then(e=>{Be(e.unread_count)}).catch(e=>console.error("Error when getting the number of unread messages: ",e))}function Be(e){"setAppBadge"in navigator?e>0?navigator.setAppBadge(e).catch(t=>{console.error("Error when installing badge: ",t)}):navigator.clearAppBadge().catch(t=>{console.error("Error when clearing badge: ",t)}):console.error("Badge API not supported")}function W(){g(),setInterval(g,6e4*5)}var v=!1,E=null,H=new Set,p=null,k=!0,j=!1,Y=localStorage.getItem("active")?parseInt(localStorage.getItem("active"),10):1,L=document.getElementById("daily-container");function G(){v=!1,E=null,H=new Set,j=!1}function V(e){let t=document.getElementById("all"),n=document.getElementById("unread"),o=document.getElementById("button-bg");e===1?(o.style.left=t.offsetLeft+"px",o.style.width=t.offsetWidth+"px",o.style.height=t.offsetHeight+"px",t.classList.add("text-white"),n.classList.remove("text-white"),localStorage.setItem("active",1),k=!1,p="/api/daily/feed",G(),L.innerHTML="",P(p)):e===2&&(o.style.left=n.offsetLeft+"px",o.style.width=n.offsetWidth+"px",o.style.height=n.offsetHeight+"px",n.classList.add("text-white"),t.classList.remove("text-white"),localStorage.setItem("active",2),k=!0,p="/api/daily/feed?unread=true",G(),L.innerHTML="",P(p)),o.classList.add("transition-all")}function K(){Y===1?p="/api/daily/feed":p="/api/daily/feed?unread=true",window.onload=()=>{V(Y)},window.setActive=V,Ae()}function P(e){j||v||(v=!0,E&&(e+=`?last_item_id=${E}`),fetch(e).then(t=>t.json()).then(t=>{Me(t),v=!1}).catch(t=>{console.error("Error fetching daily data:",t),i("Failed to fetch the daily data","error"),v=!1}))}function Me(e){if(e.forEach(t=>{if(H.has(t.id))return;H.add(t.id);let n={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"},s=new Date(t.pub_date).toLocaleString("en-GB",n),a=document.createElement("div");a.className="daily-item",a.dataset.id=t.id,a.dataset.read=t.read,a.innerHTML=DOMPurify.sanitize(Ce(t,s)),L.appendChild(a)}),e.length>0?E=e[e.length-1].id:(j=!0,console.log("No more items")),e.length<3&&k){let t=document.createElement("div");t.innerHTML=DOMPurify.sanitize(_e()),L.appendChild(t),k=!1}}function Ce(e,t){return`
        <!-- Article item -->
        <div class="flex flex-col w-full mt-14 animate-itemShow">
            <div class="w-full flex flex-col lg:flex-row">
                ${e.image!==null?`<div class="flex flex-col mr-6 mb-4 lg:mb-0 pt-2"><img src="${e.image}" class="max-w-[200px] min-w-[200px] rounded-2xl"></div>`:'<div class="flex flex-col mr-6 mb-4 lg:mb-0 pt-2 min-w-[200px] rounded-2xl items-center justify-center text-gray-500"></div>'}
                <div class="flex w-full flex-col">
                    <div class="flex flex-col w-full d-content ${localStorage.getItem("font-size")?localStorage.getItem("font-size"):"text-lg"}" ${e.read?'style="color: #c4c4c4;"':""}>
                            ${e.summary}
                            </div>
                                                
                    <div class="flex flex-col w-full">
                        <div class="flex w-full mt-3">
                            <ul class="flex flex-col w-full d-links">
                                ${e.articles.map(n=>`
                                    <li class="mb-3">
                                        <a href="${n.link}" class="${e.read?'text-gray-500"':""}" target="_blank">${n.title}</a><br><span class="text-gray-700 uppercase text-xs mb-2">${n.feed_title}</span>
                                    </li>`).join("")}
                            </ul>
                        </div>

                        <div class="flex w-full mt-3 d-pubdate">
                            ${t} &nbsp&nbsp&nbsp  &nbsp&nbsp&nbsp
                            <button class="flex ai-summarize-daily-btn -mt-0.5 hover:text-white relative" data-id="${e.id}"><span class="absolute group">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6">
                                            <path fill-rule="evenodd" d="M2.625 6.75a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Zm4.875 0A.75.75 0 0 1 8.25 6h12a.75.75 0 0 1 0 1.5h-12a.75.75 0 0 1-.75-.75ZM2.625 12a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0ZM7.5 12a.75.75 0 0 1 .75-.75h12a.75.75 0 0 1 0 1.5h-12A.75.75 0 0 1 7.5 12Zm-4.875 5.25a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Zm4.875 0a.75.75 0 0 1 .75-.75h12a.75.75 0 0 1 0 1.5h-12a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                                </svg><span class="invisible group-hover:visible relative -top-14 -left-12 px-2 py-1.5 rounded bg-gray-900 text-white text-nowrap">Article Summary</span></span>
                                
                            </button>
                            <div class="ml-12">
                            ${e.read?'<span class="absolute group"><svg class="-mt-0.5 w-6 h-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" > <path fill-rule="evenodd" d="M2 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10S2 17.523 2 12Zm13.707-1.293a1 1 0 0 0-1.414-1.414L11 12.586l-1.793-1.793a1 1 0 0 0-1.414 1.414l2.5 2.5a1 1 0 0 0 1.414 0l4-4Z" clip-rule="evenodd" /></svg><span class="invisible group-hover:visible relative -top-14 -left-10 px-2 py-1.5 rounded bg-gray-900 text-white normal-case text-nowrap">Already Read</span></span>':""}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
    `}function _e(){return`
        <div class="flex justify-center items-center h-64 mb-[100%] text-gray-500 text-base">
        There are no more unread items.
        </div>
    `}function Ae(){window.addEventListener("scroll",()=>{window.innerHeight+window.scrollY>=document.body.offsetHeight-document.body.offsetHeight/2&&P(p),He()})}function He(){document.querySelectorAll(".daily-item").forEach(t=>{if(!(t.dataset.read==="true")&&je(t)){let o=t.dataset.id;Pe(o),t.dataset.read="true"}})}function Pe(e){fetch(`/mark_as_read/daily/${e}`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}}).then(t=>{t.ok?g():console.error(`Error marking summarized article ${e} as read`)}).catch(t=>{console.error(`Error marking summarized article ${e} as read`,t),i("Error marking article as read","error")})}function je(e){let t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}var z=!1,w=null,O=new Set,Q=null;window.pauseUpdates=D;window.resumeUpdates=I;window.updateFeed=De;window.deleteFeed=Fe;window.updateFeedCategory=qe;function Oe(e,t){if(e.size!==t.size)return!1;for(let n of e){let o=Array.from(t).find(s=>s.id===n.id);if(!o||JSON.stringify(n.feeds)!==JSON.stringify(o.feeds))return!1}return!0}function D(){z=!0,clearInterval(w),w=null}function I(){z=!1,h(),w===null&&(w=setInterval(h,5e3))}async function m(e=!1){e&&(O=new Set);try{let n=await(await fetch("/api/categories_and_blogs")).json(),o=document.getElementById("categories_and_blogs"),s=new Set(n.categories_and_blogs);Oe(s,O)||(o.innerHTML="",n.categories_and_blogs.forEach(a=>{if(a.feeds.length>0){let d=`<p class="text-base mt-6 mb-1 font-medium text-gray-200"><a href="/category/${a.id}">${a.name}</a></p>`;a.feeds.forEach(r=>{let c=`/category/${a.id}/feed/${r.feed.id}`,u=`/category/${a.id}/feed/${r.feed.id}/all`,C=window.location.pathname===c||window.location.pathname===u,_=`<div x-data="{ open: false, editMode: false, title: '${r.feed.title}', menuOpen: false }" class="">
                                <div class="flex w-full" @mouseover="open = true" @mouseout="open = false">
                                    <div class="flex flex-row w-full">
                                        <div :class="{ 'active-feed': ${C}, 'block text-sm mt-1 mb-1 pt-1 pr-2 text-gray-400 flex-grow': !${C} }">
                                            <a x-show="!editMode" class="hover:text-white" href="${c}">${r.feed.title.length>28?r.feed.title.substring(0,25)+"...":r.feed.title}</a>                    
                                            
                                            <input id='input-${r.feed.id}' 
                                            x-show="editMode" 
                                            x-model="title" 
                                            x-ref="input" @keydown.enter="editMode = false; 
                                            updateFeed('${r.feed.id}', title).then(() => resumeUpdates());" @keydown.escape="editMode = false; resumeUpdates()" @blur="editMode = false; resumeUpdates()" class="bg-gray-800 text-white px-2 py-1 flex -m-0.5 w-full rounded" x-init="$watch('editMode', value => { if (value) setTimeout(() => $refs.input.focus(), 50) })" />

                                        </div>
                                        <div class="relative inline-block text-left" x-show="open && !editMode">
                                            <button @click="menuOpen = !menuOpen; $event.stopPropagation(); pauseUpdates();" class="inline-flex -ml-5 justify-center w-full rounded-md shadow-sm text-md font-bold hover:text-gray-200 text-white focus:outline-none">
                                                <span class="mt-1">...</span>
                                            </button>
                                        </div>
                                        ${r.unread_count>0?`<div class="flex pt-1 pb-1 px-2 mt-2 max-h-8 items-center justify-center text-xs font-bold rounded-md bg-gray-900 ml-auto">${r.unread_count}</div>`:""}
                                    </div>
                                </div>
                                <div x-show="menuOpen" @click.away="menuOpen = false; resumeUpdates()"
                                x-transition:enter="transition ease-out duration-300"
                                x-transition:enter-start="opacity-0 transform scale-95"
                                x-transition:enter-end="opacity-100 transform scale-100"
                                x-transition:leave="transition ease-in duration-300"
                                x-transition:leave-start="opacity-100 transform scale-100"
                                x-transition:leave-end="opacity-0 transform scale-95"
                                class="w-full bg-slate-800 border border-gray-800 text-white py-2 px-4 mt-1 rounded-md shadow-lg flex justify-between">
                                    <div class="flex-col w-full">
                                        <div class="flex w-full">
                                            <a @click="editMode = true; menuOpen = false; pauseUpdates()" class="block px-6 py-2 text-sm text-gray-300 rounded-lg bg-stone-800 hover:bg-gray-900 hover:text-white cursor-pointer">Rename</a>
                                            <a @click="deleteFeed('${r.feed.id}')" class="block ml-auto px-8 py-2 text-sm text-red-700 rounded-lg bg-stone-800 hover:bg-gray-900 hover:text-red-600 cursor-pointer">Delete</a>
                                        </div>
                                        <div class="w-full flex-grow mt-2 mb-1">
                                            <select id="ns-select" @change="updateFeedCategory('${r.feed.id}', $event.target.value)" class="block w-full px-6 py-2 text-sm text-gray-300 rounded-lg bg-stone-800 hover:bg-gray-900 hover:text-white cursor-pointer">
                                                <option value="" disabled selected>Change category</option>
                                                ${n.categories_and_blogs.map(b=>`<option value="${b.id}">${b.name}</option>`).join("")}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>`;d+=_}),o.innerHTML+=d}}),O=s)}catch(t){console.error("Error fetching categories and blogs:",t)}}async function ze(){try{let t=await(await fetch("/api/last_sync")).json();t.last_sync!=Q&&(document.getElementById("last_sync").innerText=t.last_sync,Q=t.last_sync)}catch(e){console.error("Error fetching last sync time:",e)}}async function De(e,t){try{let n=await fetch(`/api/feeds/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t})});if(!n.ok){let o=await n.json();throw new Error(o.error||"Error updating feed")}document.querySelector(`a[href$="/feed/${e}"]`).textContent=t,i("Feed has been successfully renamed","success")}catch(n){i(n.message,"error")}}async function qe(e,t){try{D();let n=await fetch(`/api/feeds/${e}/category`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({category_id:t})});if(!n.ok){let o=await n.json();throw new Error(o.error||"Error updating feed category")}await m(),i("Feed category updated successfully","success")}catch(n){i(n.message,"error")}finally{I()}}async function Fe(e){try{let t=await fetch(`/api/feeds/${e}`,{method:"DELETE"});if(!t.ok){let n=await t.json();throw new Error(n.error||"Error when deleting feed")}await m(),i("Feed deleted successfully","success")}catch(t){i(t.message,"error")}}function Ue(){document.querySelectorAll(".menu").length>0&&(document.querySelectorAll("[x-data]").forEach(e=>{e.__x.$data.menuOpen=!1}),I())}function X(){window.addEventListener("focus",I),window.addEventListener("blur",D),document.addEventListener("visibilitychange",h),document.addEventListener("click",function(e){e.target.closest(".menu")||Ue()})}function ee(){w=setInterval(h,5e3)}async function h(){!document.hidden&&!z&&(await m(),await ze())}function te(){document.getElementById("create-category-link").addEventListener("click",function(e){e.preventDefault(),document.getElementById("create-category-link").style.display="none",document.getElementById("category-select").style.display="none",document.getElementById("new-category-input").style.display="block",document.getElementById("choose-category-link").style.display="flex"}),document.getElementById("choose-category-link").addEventListener("click",function(e){e.preventDefault(),document.getElementById("create-category-link").style.display="flex",document.getElementById("category-select").style.display="block",document.getElementById("new-category-input").style.display="none",document.getElementById("choose-category-link").style.display="none"}),document.getElementById("submit-button").addEventListener("click",async function(e){e.preventDefault(),document.getElementById("loading-spinner").style.display="block",document.querySelector(".add-feed-text").style.display="none";let t=document.getElementById("new-category-input"),n=document.getElementById("category-select"),o=document.getElementById("category");t.style.display==="block"&&t.value.trim()!==""?o.value=t.value.trim():o.value=n.options[n.selectedIndex].text;let s=document.getElementById("add_feed"),a=new FormData(s);try{let r=await(await fetch("/add_feed",{method:"POST",body:a})).json();document.getElementById("loading-spinner").style.display="none",document.querySelector(".add-feed-text").style.display="block",r.success?window.location.href="/":document.getElementById("error").innerText=r.error}catch(d){document.getElementById("loading-spinner").style.display="none",document.querySelector(".add-feed-text").style.display="block",document.getElementById("error").innerText="An error occurred while submitting the form.",console.error("Error:",d)}}),document.addEventListener("DOMContentLoaded",async()=>{let e=document.getElementById("modal-add");e.classList.remove("hidden"),e.classList.add("flex");let t=document.getElementById("category-select");try{(await(await fetch("/api/categories_and_blogs")).json()).categories_and_blogs.forEach(s=>{let a=document.createElement("option");a.value=s.id,a.text=s.name,t.appendChild(a)})}catch(n){console.error("Error getting categories:",n)}})}function ne(e){return e=e.replace(/<li>(.*?)<\/li>/g,`- $1
`),e=e.replace(/<\/ul>/g,`
`).replace(/<ul>/g,""),e=e.replace(/<p>(.*?)<\/p>/g,`$1

`),e=e.replace(/<\/?[^>]+>/g,""),e}function q(){document.addEventListener("click",function(e){let t=e.target.closest(".ai-summarize-btn, .ai-summarize-daily-btn"),n=e.target.closest(".copy-btn");if(t){let o,s=!1,a,d,r,c;if(t.classList.contains("ai-summarize-daily-btn")){o=t.dataset.id;let l=t.closest(".daily-item");a=l.querySelector(".d-content"),r=l,s=!0}else{let l=t.closest(".feed-item");r=l.querySelector(".item-title"),d=l.querySelector(".item-title a").href,o=l.dataset.id,a=l.querySelector(".feed-content"),c=l.querySelector("#exp-hidden"),c&&(c.setAttribute("x-data","{expanded: true}"),c.style.maxHeight="none")}let u=r.getBoundingClientRect().top+window.scrollY,_=window.innerHeight*(20/100),b=u-_;window.scrollTo({top:b,behavior:"smooth"});let Se=500,A=a.innerHTML;a.innerHTML=`
            <div class="space-y-4 w-full">
                <div class="line"></div>
                <div class="line short"></div>
                <div class="line"></div>
                <div class="line"></div>
                <div class="line short"></div>
                <div class="line"></div>
                <div class="line"></div>
                <div class="line short"></div>
                <div class="line"></div>
                <div class="line"></div>
                <div class="line short"></div>
                <div class="line"></div>
            </div>`;let Te=s?`/api/daily/summarize/${o}`:"/api/summarize",$e=s?{}:{url:d};setTimeout(()=>{fetch(Te,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify($e)}).then(l=>l.json()).then(l=>{if(l.status==="error"){if(l.error.includes("Failed to get text")){a.innerHTML=A,i("Failed to get article text from the URL.","error");return}i('Error summarizing the text. Check Groq API in <a class="underline" href="/settings">Settings</a>.',"error"),a.innerHTML=A}else a.innerHTML=`
                        <div class="w-full animate-itemShow">
                            <div id="summary-text">${l.summary}</div>
                        ${Ne()}
                        </div>`}).catch(l=>{i("Error summarizing the text","error"),console.error("Error:",l),a.innerHTML=A})},Se)}if(n){let o=n.parentElement.parentElement.querySelector("#summary-text"),s=ne(o.innerHTML);navigator.clipboard.writeText(s).then(()=>{i("The text has been copied to clipboard.","success")}).catch(a=>{console.error("Error copying text: ",a),i("Error copying text","error")})}})}var Ne=()=>`
    <div class="w-fit mt-4 mb-4 ml-auto ">

        <button class="relative copy-btn flex ml-auto hover:text-stone-700 group">

        <span class="absolute bg-gray-900 rounded-md px-2.5 py-2 -top-1 left-0 -ml-56 text-nowrap invisible text-sm group-hover:visible  text-white">Copy summary to clipboard</span>   
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path fill-rule="evenodd" d="M7.502 6h7.128A3.375 3.375 0 0 1 18 9.375v9.375a3 3 0 0 0 3-3V6.108c0-1.505-1.125-2.811-2.664-2.94a48.972 48.972 0 0 0-.673-.05A3 3 0 0 0 15 1.5h-1.5a3 3 0 0 0-2.663 1.618c-.225.015-.45.032-.673.05C8.662 3.295 7.554 4.542 7.502 6ZM13.5 3A1.5 1.5 0 0 0 12 4.5h4.5A1.5 1.5 0 0 0 15 3h-1.5Z" clip-rule="evenodd" />
                <path fill-rule="evenodd" d="M3 9.375C3 8.339 3.84 7.5 4.875 7.5h9.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V9.375ZM6 12a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V12Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75ZM6 15a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V15Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75ZM6 18a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V18Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
            </svg>  
                
        </button>
        
        
    </div>`;function oe(e){let t=window.location.pathname,o="/api/feeditems";if(t==="/"||t==="")o+="";else if(t.includes("/category/")){let s=t.split("/"),a=s[s.indexOf("category")+1];if(t.includes("/feed/")){let d=s[s.indexOf("feed")+1];o+=`/${a}/${d}`}else o+=`/${a}`}return t.endsWith("/all")&&(o+="/all"),`${o}?limit=5${e?`&last_item_id=${e}`:""}`}var y=!1,se=null,ae=!1,ie=new Set;function le(){window.addEventListener("scroll",Je)}function F(){let e=document.getElementById("feed-container");if(y||ae)return;y=!0;let t=oe(se);fetch(t).then(n=>n.json()).then(n=>{n.length>0&&(n.forEach(o=>{let s=document.createElement("div");s.classList.add("feed-item","animate-itemShow"),s.dataset.read=o.read,s.dataset.id=o.id;let a={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"},r=new Date(o.pub_date).toLocaleString("en-GB",a),c=o.creator!==null?o.creator:"";s.innerHTML=`
                            <div class="tb-feed-name">${o.feed_title}</div>
                            <h1 class="item-title"><a class="hover:text-blue-200" target="_blank" rel="noopener noreferrer" href="${o.link}">${o.title}</a></h1>
                            <div class="flex-col md:flex-row flex">
                                <div class="tb-feed-date">${r}</div> 
                                <div class="tb-feed-author">${c}</div>
                            </div>
                            <div id="exp-hidden" x-data="{ expanded: false }" class="feed-content relative ${localStorage.getItem("font-size")?localStorage.getItem("font-size"):"text-lg"}" :class="{ 'overflow-hidden': !expanded, 'max-h-none overflow-visible': expanded }">
                                ${o.summary}
                                <div class="absolute bottom-0 left-0 w-full h-60 bg-gradient-to-t from-slate-800 via-slate-800/90 to-slate-800/0 pointer-events-none" x-show="!expanded"></div>
                                <button class="absolute bottom-0 left-0 w-full text-center py-2 font-bold text-white transition-colors focus:outline-none" x-show="!expanded" @click="expanded = true">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-11 w-15 h-15 ml-auto mr-auto shadow-2xl shadow-stone-950 bg-black transition duration-50 hover:bg-stone-700 mb-4 p-3 rounded-full gradient-arrow">
                                        <path fill-rule="evenodd" d="M11.47 13.28a.75.75 0 0 0 1.06 0l7.5-7.5a.75.75 0 0 0-1.06-1.06L12 11.69 5.03 4.72a.75.75 0 0 0-1.06 1.06l7.5 7.5Z" clip-rule="evenodd" />
                                        <path fill-rule="evenodd" d="M11.47 19.28a.75.75 0 0 0 1.06 0l7.5-7.5a.75.75 0 1 0-1.06-1.06L12 17.69l-6.97-6.97a.75.75 0 0 0-1.06 1.06l7.5 7.5Z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>

                            <!-- AI Summarize -->
                            <div class="flex  ml-6 xl:ml-16 mr-6 mt-4 justify-start max-w-3xl">
                                <div x-data="{ open: false }" @mouseover="open = true" @mouseout="open = false" class="relative">
                                    <button class="ai-summarize-btn flex items-center justify-center rounded-lg border border-gray-800 hover:border-gray-700 focus:outline-none px-3 py-2 text-gray-400 transition-all duration-700 overflow-hidden" :class="{'w-32': open, 'w-14': !open}">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6">
                                            <path fill-rule="evenodd" d="M2.625 6.75a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Zm4.875 0A.75.75 0 0 1 8.25 6h12a.75.75 0 0 1 0 1.5h-12a.75.75 0 0 1-.75-.75ZM2.625 12a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0ZM7.5 12a.75.75 0 0 1 .75-.75h12a.75.75 0 0 1 0 1.5h-12A.75.75 0 0 1 7.5 12Zm-4.875 5.25a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Zm4.875 0a.75.75 0 0 1 .75-.75h12a.75.75 0 0 1 0 1.5h-12a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                                        </svg>
                                        <span id="ai-summarize-btn-text" x-show="open" class="flex text-nowrap text-base">AI Summarize</span>
                                    </button>
                                </div>
                            </div>
                        `,e.appendChild(s),Ze(s)}),se=n[n.length-1].id,y=!1),n.length===1||n.length===2?(re(e),y=!1):n.length===0&&(re(e),y=!1,ae=!0)}).catch(n=>{console.error("Error fetching the feed items:",n),y=!1})}function re(e){if(document.getElementById("empty"))return;let t=window.location.pathname.includes("/all")?"There's nothing here.":"There are no more unread items.",n=document.createElement("div");n.id="empty",n.className="empty-message",n.innerHTML=`
                <div class="w-full text-center ml-auto mb-[50%] mr-auto mt-[20%] text-gray-600">
                  ${t}<br><img src="/static/imgs/cup.png" width="100px" class="ml-auto mr-auto mt-10">
                </div>`,e.appendChild(n)}function Ze(e){let t=e.querySelector(".feed-content"),n=window.innerHeight;if(e.offsetHeight>n*.8){t.style.maxHeight=`${n*.8}px`,t.style.overflow="hidden";let s=t.querySelector(".bg-gradient-to-t"),a=t.querySelector("button");s.classList.remove("hidden"),a.classList.remove("hidden"),a.addEventListener("click",()=>{t.style.maxHeight="none",t.style.overflow="visible",s.classList.add("hidden"),a.classList.add("hidden"),de()})}else{let s=t.querySelector(".bg-gradient-to-t"),a=t.querySelector("button");s&&s.classList.add("hidden"),a&&a.classList.add("hidden")}}function de(){let e=document.querySelectorAll(".feed-item"),t=window.innerHeight;e.forEach(n=>{if(n.dataset.read==="true")return;let o=n.getBoundingClientRect(),s=n.dataset.id,a=n.dataset.read==="true";o.bottom<=t*.7&&!a&&(Re(s),n.dataset.read="true")})}function Re(e){ie.has(e)||fetch(`/mark_as_read/${e}`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}}).then(t=>{t.ok?(ie.add(e),g(),m()):console.error("Error marking post as read:",t.statusText)}).catch(t=>{console.error("Error marking post as read:",t)})}function Je(){let{scrollTop:e,scrollHeight:t,clientHeight:n}=document.documentElement;e+n>=t*.7&&F(),de()}var We=document.getElementById("btnDefault"),Ye=document.getElementById("btnAll");function S(){let e=window.location.pathname,t=document.getElementById("btnDefault"),n=document.getElementById("btnAll");e.includes("/all")?(t.className="not-active-unread",n.className="active-all"):(t.className="active-unread",n.className="not-active-all")}function Ge(){let e=window.location.pathname,t=ce(e,!1);e!==t?fetch("/api/settings",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({unread:!0})}).then(()=>{localStorage.setItem("lastChoice","unread"),setTimeout(()=>{window.location.href=t},100)}):S()}function Ve(){let e=window.location.pathname,t=ce(e,!0);e!==t?fetch("/api/settings",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({unread:!1})}).then(()=>{localStorage.setItem("lastChoice","all"),setTimeout(()=>{window.location.href=t},100)}):S()}function ce(e,t){let n=e.split("/").filter(o=>o);if(t)n.includes("all")||n.push("all");else{let o=n.indexOf("all");o>-1&&n.splice(o,1)}return"/"+n.join("/")}function ue(){We.addEventListener("click",Ge),Ye.addEventListener("click",Ve)}var me=document.getElementById("update-interval"),fe=document.getElementById("clean-after"),pe=document.getElementById("timezone"),ge=document.getElementById("language"),he=document.getElementById("groq-api-key"),Ke=document.getElementById("check-groq-api-key"),U=document.getElementById("translate"),Qe=document.getElementById("change_password"),Xe=document.getElementById("new_password"),et=document.getElementById("confirm_password"),tt=document.getElementById("save-settings"),ye=document.getElementById("font-size");function ve(){fetch("/api/settings",{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{me.value=e.update_interval,fe.value=e.clean_after_days,pe.value=e.timezone,ge.value=e.language,he.value=e.groq_api_key,U.checked=e.translate,U.dispatchEvent(new Event("change")),ye.value=localStorage.getItem("font-size")||"text-lg"}).catch(e=>{console.error("Error fetching settings:",e),i("Failed to load settings","error")})}function we(){return localStorage.setItem("font-size",ye.value),new Promise((e,t)=>{let n=me.value,o=fe.value,s=pe.value,a=ge.value,d=U.checked,r=he.value,c={update_interval:n,clean_after_days:o,timezone:s,language:a,translate:d};/^[*]+$/.test(r)||(c.groq_api_key=r),fetch("/api/settings",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}).then(u=>u.json()).then(u=>{i("Settings saved successfully","success"),e(u)}).catch(u=>{console.error("Error saving settings:",u),i("Failed to save settings","error"),t(u)})})}function nt(){we().then(()=>fetch("/api/groq/check",{credentials:"include",headers:{"Content-Type":"application/json"},method:"GET"})).then(e=>e.json()).then(e=>{e.status==="success"?i("API key is valid","success"):i("API key is invalid","error")}).catch(e=>{console.error("Error checking API key:",e),i(`Failed to check API key ${e}`,"error")})}function ot(){let e=Xe.value,t=et.value;fetch("/api/settings/change_password",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({new_password:e,confirm_password:t})}).then(n=>n.json()).then(n=>{n.status==="success"?i("Password changed successfully","success"):i(n.error,"error")}).catch(n=>{console.error("Error changing password:",n),i("Failed to change password","error")})}function xe(){Ke.addEventListener("click",nt),Qe.addEventListener("click",ot),tt.addEventListener("click",we)}function be(){function e(){let n=navigator.userAgent.toLowerCase();return n.includes("safari")&&!n.includes("chrome")&&!n.includes("android")}function t(){return!window.navigator.standalone}e()&&t()&&(document.getElementById("web-app-message").innerText='You can create a Safari web app and open it as an application on your device (on macOS Sonoma and later or iOS 11.3 and later). Click the share button and select "Add to Dock" or "Add to Home Screen".')}async function x(){try{let t=await(await fetch("/api/categories_and_blogs")).json(),n=document.getElementById("cat-list");n.innerHTML="",t.categories_and_blogs.forEach(o=>{let s="";o.name!=="Unnamed"&&(s=`
                <button id="delete-${o.id}" class="text-sm px-3 text-red-700 hover:text-red-800 focus:outline-none ml-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                        <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z" clip-rule="evenodd" />
                    </svg>
                </button>`);let a=`
                <div x-data="{ editMode: false, newName: '${o.name}', timeout: null }" class="flex w-full border-b border-gray-900 ">
                    <span x-show="!editMode" class="block text-base w-full mt-4 mb-2 pb-2 pt-2 px-3 font-medium text-gray-200 cursor-pointer" @click="if('${o.name}' !== 'Unnamed') { editMode = true; requestAnimationFrame(() => { $refs.input.focus(); }); }">${o.name}</span>

                    <input x-show="editMode" x-model="newName" x-ref="input" @keydown.enter="saveCategory(${o.id}, newName); editMode = false" type="text" class="text-base flex w-full mt-4 mb-2 pb-2 pt-2 px-3 mr-1 font-medium text-gray-200 bg-slate-900 rounded-lg border-0 focus:outline-none" @blur="timeout = setTimeout(() => editMode = false, 100)" x-init="$watch('editMode', value => { if (value) setTimeout(() => $refs.input.focus(), 50) })" />

                    <button x-show="editMode" @click="clearTimeout(timeout); saveCategory(${o.id}, newName); editMode = false" class="ml-2 mr-2 mt-4 mb-2 px-3 py-1 h-10 font-semibold text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md focus:outline-none">Save</button>
                    ${s}
                </div>`;n.innerHTML+=a}),t.categories_and_blogs.forEach(o=>{o.name!=="Unnamed"&&document.getElementById(`delete-${o.id}`).addEventListener("click",async()=>{try{let s=await fetch(`/api/settings/categories/delete/${o.id}`,{method:"DELETE"});s.ok?(x(),m(!0),i("Category deleted successfully","success")):console.error("Error deleting category:",await s.text())}catch(s){console.error("Error deleting category:",s)}})})}catch(e){i("Error fetching categories and blogs","error"),console.error("Error fetching categories and blogs:",e)}}async function Ee(){let e=document.getElementById("new-category"),t=e.value;if(!t){i("Category name is required","error");return}let n=await fetch("/api/settings/categories/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})}),o=await n.json();if(!n.ok){i("Error: "+o.error,"error");return}e.value="",i("Category added successfully","success"),x(),m(!0)}window.saveCategory=async(e,t)=>{let n=await fetch(`/api/settings/categories/rename/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({new_name:t})}),o=await n.json();if(!n.ok){i("Error: "+o.error,"error");return}i("Category renamed successfully","success"),x(),m(!0)};function ke(){document.getElementById("add-new-category").addEventListener("click",Ee),document.getElementById("new-category").addEventListener("keydown",async e=>{e.key==="Enter"&&Ee()})}var f=document.getElementById("active"),$=document.getElementById("title-compare"),T=document.getElementById("other-settings"),B=document.getElementById("translate"),M=document.getElementById("process-read"),N=document.getElementById("hours-summary"),Z=document.getElementById("sync-at-hours"),R=document.getElementById("sync-at-minutes"),st=document.getElementById("save-settings");function at(e){let t=e.split(" ")[0].split(":"),n=t[0],o=t[1];Z.value=n,R.value=o}function it(e){let t=document.getElementById("feed-list");t.innerHTML="",e.feeds.forEach(n=>{let o=document.createElement("div"),s="feed-"+n.id,a=22,d=n.title.length>a?n.title.substring(0,a)+"...":n.title;o.innerHTML=`
        <label class="flex min-w-60 mr-6 p-4 border rounded-lg font-bold mb-4 ${n.daily_enabled?"border-green-800 text-white bg-green-800":" text-gray-500 border-gray-700"}">
        <input type="checkbox" class="mr-2 hidden" id="${s}" name="myCheckbox" ${n.active?"checked":""} />
        ${d} 
        </label>
        `;let r=o.querySelector(`#${s}`);r.addEventListener("change",c=>{let u=r.parentElement;c.target.checked?(u.classList.add("border-green-800","text-white","bg-green-800"),fetch("/api/settings/daily/feed",{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({id:n.id,dailyEnabled:!0})}).catch(console.error())):(u.classList.remove("border-green-800","text-white","bg-green-800"),u.classList.add("text-gray-500","border-gray-700"),fetch("/api/settings/daily/feed",{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({id:n.id,dailyEnabled:!1})}).catch(console.error()))}),t.appendChild(o)})}function J(){fetch("/api/settings/daily",{method:"GET",credentials:"include"}).then(e=>e.json()).then(e=>(N.value=e.hours_summary,M.checked=e.process_read,M.dispatchEvent(new Event("change")),B.checked=e.translate,B.dispatchEvent(new Event("change")),$.checked=e.compare_titles,$.dispatchEvent(new Event("change")),f.checked=e.active,f.dispatchEvent(new Event("change")),at(e.daily_sync_at),it(e),e)).catch(e=>{console.log("Error: ",e),i("Error fetching daily settings","error")})}function rt(){let e={hours_summary:N.value,process_read:M.checked,translate:B.checked,compare_titles:$.checked,active:f.checked,sync_at:`${Z.value}:${R.value}:00`};fetch("/api/settings/daily",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}).then(t=>t.json()).then(()=>{J()}).catch(t=>{console.log("Error: ",t),i("Error disabling daily settings","error")})}function lt(){let e={hours_summary:N.value,process_read:M.checked,translate:B.checked,compare_titles:$.checked,active:f.checked,sync_at:`${Z.value}:${R.value}:00`};fetch("/api/settings/daily",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),credentials:"include"}).then(t=>t.json()).then(()=>{i("Daily settings saved successfully","success"),J()}).catch(t=>{console.log("Error: ",t),i("Error saving daily settings","error")})}function dt(){f.addEventListener("change",()=>{f.checked?(T.classList.remove("hidden"),T.classList.add("flex","flex-col")):(T.classList.remove("flex","flex-col"),T.classList.add("hidden"))}),f.addEventListener("click",()=>{f.checked||rt()}),st.addEventListener("click",()=>{lt()})}function Le(){dt(),J()}function Ie(){let e=null;window.addEventListener("touchstart",t=>{e=t.touches[0].clientY}),window.addEventListener("touchend",t=>{t.changedTouches[0].clientY-e>200&&window.scrollY<50&&location.reload()})}h();X();ee();window.location.pathname==="/daily"&&(K(),q());(window.location.pathname.endsWith("/")||window.location.pathname.endsWith("/all")||window.location.pathname.includes("/category"))&&(F(),S(),ue(),q(),le());if(window.location.pathname.endsWith("/categories")){async function e(){await x()}e(),ke()}window.location.pathname.endsWith("/settings")&&(ve(),xe(),be());window.location.pathname.endsWith("settings/daily")&&Le();te();W();Ie();})();
